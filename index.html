<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor Médico Inteligente - Visión por Computador</title>
    <!-- Carga de Tailwind CSS para un diseño responsivo y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Un gris muy claro */
        }
        .container-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Encabezado -->
    <header class="bg-blue-600 text-white p-4 container-shadow">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold text-center md:text-left">
                Práctica 2: Visor Médico Inteligente
            </h1>
            <div class="text-sm mt-2 md:mt-0 text-center md:text-right">
                <h2 class="font-semibold">Python + FastApi + OpenCV/SimpleITK</h2>
                <p><strong>Autores:</strong> Jorge Cueva | Kevin Yansaguano</p>
            </div>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="flex-grow max-w-7xl mx-auto p-4 md:p-8 w-full">
        
        <!-- Controles de Carga y Configuración -->
        <section class="bg-white p-6 rounded-xl container-shadow mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Carga y Procesamiento de Imagen (Corte Único)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <!-- Selector de Archivo -->
                <div>
                    <label for="imageFile" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Imagen Médica (.ima, .nii, .dcm)</label>
                    <input type="file" id="imageFile" accept=".nii,.nii.gz,.dcm,.ima" 
                           class="w-full border border-gray-300 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 
                                  file:rounded-full file:border-0 file:text-sm file:font-semibold
                                  file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-150">
                    <p id="fileNameDisplay" class="text-xs text-gray-500 mt-1 truncate"></p>
                </div>
                
                <!-- Botón de Procesamiento -->
                <div>
                    <button id="processButton" onclick="processImage()"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl 
                                   transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-400 disabled:cursor-not-allowed"
                            disabled>
                        Procesar Imagen y Extraer ROIs
                    </button>
                </div>
            </div>
            <div id="statusMessage" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
        </section>

        <!-- Contenedor de Resultados -->
        <section id="resultsSection" class="hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">2. Resultados del Análisis y Áreas de Interés</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Imagen Final Resaltada -->
                <div class="bg-white p-5 rounded-xl container-shadow">
                    <h4 class="text-lg font-semibold mb-3 border-b pb-1 text-red-600">Resultado Final: Resaltado de ROIs</h4>
                    <div class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center p-2">
                        <img id="finalImage" class="max-h-full max-w-full rounded-lg object-contain" alt="Imagen final con áreas de interés resaltadas (ROIs)">
                    </div>
                    <p class="text-sm mt-3">
                        <span class="font-semibold">Resaltado:</span> Pulmón (<span class="text-cyan-600">Cian</span>), Corazón/Tejido Blando (<span class="text-red-600">Rojo</span>), Hueso (<span class="text-green-600">Verde</span>).
                    </p>
                </div>

                <!-- Imagen Original Normalizada -->
                <div class="bg-white p-5 rounded-xl container-shadow">
                    <h4 class="text-lg font-semibold mb-3 border-b pb-1 text-blue-600">Paso Intermedio: Slice Original (8-bit)</h4>
                    <div class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center p-2">
                        <img id="originalImage" class="max-h-full max-w-full rounded-lg object-contain" alt="Slice original de la imagen médica normalizado a 8 bits">
                    </div>
                    <p class="text-sm mt-3">
                        <span class="font-semibold">Fuente:</span> La imagen base de 16-bit (HU) normalizada a 8-bit para visualización.
                    </p>
                </div>
                
            </div>
            
            <!-- Operaciones Intermedias / Evidencia del Proceso -->
            <div class="bg-white p-6 rounded-xl container-shadow mt-8">
                <h4 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Evidencia del Proceso Lógico (Máscaras y Detección)</h4>
                <div id="intermediateImages" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Las imágenes intermedias se cargarán aquí -->
                    <p class="text-gray-500 col-span-full">Cargando pasos intermedios...</p>
                </div>
            </div>

        </section>

    </main>

    <!-- Pie de Página -->
    <footer class="mt-auto bg-gray-200 text-gray-700 p-4 text-center text-sm container-shadow">
        <div class="max-w-7xl mx-auto">
            <p>Universidad Politécnica Salesiana | Asignatura: Visión por Computador</p>
            <p><strong>Período 2025</strong></p>
        </div>
    </footer>

    <!-- Lógica de JavaScript -->
    <script>
        // URL base de la API de FastAPI
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        let uploadedFilename = null;

        const fileInput = document.getElementById('imageFile');
        const processButton = document.getElementById('processButton');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const resultsSection = document.getElementById('resultsSection');
        const finalImage = document.getElementById('finalImage');
        const originalImage = document.getElementById('originalImage');
        const intermediateImagesContainer = document.getElementById('intermediateImages');

        // Función de utilidad para manejar mensajes de estado
        function setStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'mt-4 p-3 rounded-lg text-sm'; // Reset class
            
            if (type === 'info') {
                statusMessage.classList.add('bg-blue-100', 'text-blue-700');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'loading') {
                statusMessage.classList.add('bg-yellow-100', 'text-yellow-700', 'animate-pulse');
            }
            statusMessage.classList.remove('hidden');
        }

        // ----------------------------------------------------
        // PASO 1: MANEJO DE LA SUBIDA DE ARCHIVOS
        // ----------------------------------------------------

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) {
                uploadedFilename = null;
                processButton.disabled = true;
                fileNameDisplay.textContent = '';
                resultsSection.classList.add('hidden');
                setStatus('Por favor, selecciona un archivo.', 'info');
                return;
            }

            fileNameDisplay.textContent = `Archivo seleccionado: ${file.name}`;
            processButton.disabled = true;
            setStatus('Subiendo archivo...', 'loading');
            resultsSection.classList.add('hidden');

            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(`${API_BASE_URL}/uploadfile/`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error de servidor: ${response.statusText}`);
                }

                const data = await response.json();
                uploadedFilename = data.filename;
                processButton.disabled = false;
                setStatus(`¡Archivo subido con éxito! Listo para procesar: ${uploadedFilename}`, 'success');

            } catch (error) {
                console.error('Error al subir el archivo:', error);
                setStatus(`Error al subir: ${error.message}`, 'error');
                uploadedFilename = null;
            }
        });

        // ----------------------------------------------------
        // PASO 2: PROCESAR IMAGEN
        // ----------------------------------------------------

        async function processImage() {
            if (!uploadedFilename) {
                setStatus('Primero debes subir un archivo.', 'error');
                return;
            }
            
            // Ya no leemos sliceIndex. Por defecto usamos 0, o simplemente no lo enviamos si es 2D.
            const sliceIndex = 0; 

            processButton.disabled = true;
            setStatus(`Procesando imagen (corte único)... Esto puede tomar unos segundos.`, 'loading');
            resultsSection.classList.add('hidden');
            intermediateImagesContainer.innerHTML = '<p class="text-gray-500 col-span-full">Cargando pasos intermedios...</p>';
            
            // Construir la URL: enviamos slice_index=0 por si acaso el backend lo espera, 
            // aunque el backend lo ignorará si es un archivo 2D (.ima)
            const url = `${API_BASE_URL}/process/${uploadedFilename}?slice_index=${sliceIndex}`;

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    const error = await response.json();
                    const errorMessage = error.detail || `Error de servidor: ${response.statusText}. Verifica la consola para más detalles.`;
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                const urls = data.saved_files_urls;
                
                if (!urls || !urls.intermediate_images || !urls.extracted_masks) {
                    throw new Error("Estructura de respuesta inválida. Faltan claves de rutas (intermediate_images/extracted_masks).");
                }

                // Mostrar la imagen final (resaltada) en Base64
                const base64Image = data.image_highlighted_base64;
                if (base64Image) {
                    finalImage.src = `data:image/png;base64,${base64Image}`;
                    finalImage.alt = 'Imagen final con ROIs';
                }

                // Cargar las imágenes intermedias usando las URLs estáticas
                displayIntermediateImages(urls);
                
                setStatus(`¡Procesamiento completo!`, 'success');
                resultsSection.classList.remove('hidden');

            } catch (error) {
                console.error('Error al procesar la imagen:', error);
                setStatus(`Error al procesar: ${error.message}`, 'error');
            } finally {
                processButton.disabled = false;
            }
        }

        // ----------------------------------------------------
        // PASO 3: MOSTRAR IMÁGENES INTERMEDIAS
        // ----------------------------------------------------

        function displayIntermediateImages(urls) {
            intermediateImagesContainer.innerHTML = '';
            
            // Definir un orden y título para las imágenes intermedias
            const imageOrder = [
                { key: 'slice_8bit', title: '00. Slice Base (8-bit)', type: 'base', text_color: 'text-blue-500', group: 'intermediate_images' },
                { key: 'edges_dilated', title: '01. Detección de Bordes (Canny)', type: 'base', text_color: 'text-gray-500', group: 'intermediate_images' },
                { key: 'lung_raw', title: '02. Máscara Pulmón (Raw HU)', type: 'mask', text_color: 'text-cyan-500', group: 'extracted_masks' },
                { key: 'heart_raw', title: '03. Máscara Corazón (Raw HU)', type: 'mask', text_color: 'text-red-500', group: 'extracted_masks' },
                { key: 'bone_raw', title: '04. Máscara Hueso (Raw HU)', type: 'mask', text_color: 'text-green-500', group: 'extracted_masks' },
                { key: 'lung_refined', title: '05. Pulmón (Refinado + Morfología)', type: 'refined', text_color: 'text-cyan-700', group: 'extracted_masks' },
                { key: 'heart_refined', title: '06. Corazón (Refinado + Morfología)', type: 'refined', text_color: 'text-red-700', group: 'extracted_masks' },
                { key: 'bone_refined', title: '07. Hueso (Refinado + Morfología)', type: 'refined', text_color: 'text-green-700', group: 'extracted_masks' },
            ];

            // Cargar la imagen original (Slice Base) en el contenedor grande
            const originalUrl = urls.intermediate_images && urls.intermediate_images['slice_8bit'];
            if (originalUrl) {
                originalImage.src = `${API_BASE_URL}${originalUrl}`;
                originalImage.alt = 'Slice Original (8-bit)';
            }

            for (const item of imageOrder) {
                const url = urls[item.group] ? urls[item.group][item.key] : null;
                
                if (url) {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'bg-gray-50 p-3 rounded-xl border border-gray-200 container-shadow hover:shadow-lg transition duration-200';
                    
                    const imageUrl = `${API_BASE_URL}${url}`;

                    imageCard.innerHTML = `
                        <p class="text-xs font-semibold text-center mb-2 ${item.text_color}">${item.title}</p>
                        <div class="aspect-square bg-gray-200 rounded flex items-center justify-center p-1">
                           <img src="${imageUrl}" alt="${item.title}" class="max-h-full max-w-full rounded object-contain" 
                                onerror="this.onerror=null; this.src='https://placehold.co/150x150/f0f0f0/6b7280?text=Cargando+...';">
                        </div>
                    `;
                    
                    intermediateImagesContainer.appendChild(imageCard);
                }
            }
            
            if (intermediateImagesContainer.childElementCount === 0) {
                 intermediateImagesContainer.innerHTML = '<p class="text-gray-500 col-span-full">No se encontraron archivos intermedios. Asegúrate de que el procesamiento fue exitoso.</p>';
            }
        }
        
        window.onload = () => {
             setStatus('Bienvenido. Sube una imagen médica (.ima, .nii, .dcm) y haz click en "Procesar".', 'info');
        }

    </script>
</body>
</html>